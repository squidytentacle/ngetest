name: RDP_Tailscale_RDPWrapper

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: self-hosted
    timeout-minutes: 720

    steps:
      - name: Install RDP Wrapper (asmtron fork)
        run: |
          $url = "https://github.com/asmtron/rdpwrap/releases/download/v1.4/RDPWrap-with-Autoupdate-v1.4-Installer.exe"
          $dest = "$env:TEMP\rdpwrap-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $dest
          Start-Process $dest -ArgumentList "/silent" -Wait
          Remove-Item $dest -Force

      - name: Verify RDP Port 3389
        run: |
          $rdpPort = netstat -an | findstr 3389
          if ($rdpPort) {
              Write-Host "✅ Port 3389 is LISTENING"
          } else {
              Write-Host "❌ Port 3389 is NOT LISTENING"
              exit 1
          }

      - name: Create & Reset RDP Users with Random Passwords
        run: |
          function New-RandomPassword {
              param([int]$length = 14)
              $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()'
              -join ((1..$length) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          }

          $pass1Plain = New-RandomPassword 14
          $pass2Plain = New-RandomPassword 16

          $pass1 = ConvertTo-SecureString $pass1Plain -AsPlainText -Force
          $pass2 = ConvertTo-SecureString $pass2Plain -AsPlainText -Force

          if (-not (Get-LocalUser -Name "RDP1" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP1" -Password $pass1 -AccountNeverExpires
          } else {
              net user RDP1 $pass1Plain
          }
          if (-not (Get-LocalGroupMember -Group "Administrators" -Member "RDP1" -ErrorAction SilentlyContinue)) {
              Add-LocalGroupMember -Group "Administrators" -Member "RDP1"
          }

          if (-not (Get-LocalUser -Name "RDP2" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP2" -Password $pass2 -AccountNeverExpires
          } else {
              net user RDP2 $pass2Plain
          }
          if (-not (Get-LocalGroupMember -Group "Administrators" -Member "RDP2" -ErrorAction SilentlyContinue)) {
              Add-LocalGroupMember -Group "Administrators" -Member "RDP2"
          }

          echo "RDP1_USER=RDP1" >> $env:GITHUB_ENV
          echo "RDP1_PASS=$pass1Plain" >> $env:GITHUB_ENV
          echo "RDP2_USER=RDP2" >> $env:GITHUB_ENV
          echo "RDP2_PASS=$pass2Plain" >> $env:GITHUB_ENV

      - name: Install Tailscale (if not installed)
        run: |
          if (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe")) {
            $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
          }

      - name: Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=selfhosted-runner
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Download VFun Launcher
        run: |
          $url = "https://vfun-cdn.qijisoft.com/vlauncher/fullclient/VFUNLauncherInstaller.exe"
          $dest = "C:\VFUNLauncherInstaller.exe"
          if (-not (Test-Path $dest)) {
            Invoke-WebRequest -Uri $url -OutFile $dest
          }
          Write-Host "VFun Launcher available at $dest"

      - name: Start Anti-AFK + Ping in Background
        run: |
          $script = @'
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          Start-Job -ScriptBlock {
              $wshell = New-Object -ComObject wscript.shell
              while ($true) {
                  $keys = @("a","d","{LEFT}","{RIGHT}","{UP}","{DOWN}"," ")
                  $key = Get-Random -InputObject $keys
                  $wshell.SendKeys($key)
                  $pos = [System.Windows.Forms.Cursor]::Position
                  $newX = $pos.X + (Get-Random -Minimum -5 -Maximum 5)
                  $newY = $pos.Y + (Get-Random -Minimum -5 -Maximum 5)
                  [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($newX, $newY)
                  Start-Sleep -Seconds (Get-Random -Minimum 3 -Maximum 5)
              }
          }
          Start-Job -ScriptBlock {
              while ($true) {
                  Test-Connection -ComputerName "google.com" -Count 1 | Out-Null
                  Start-Sleep -Seconds 30
              }
          }
          '@
          $scriptPath = "C:\keepalive.ps1"
          $script | Out-File -FilePath $scriptPath -Encoding UTF8
          Start-Process powershell -ArgumentList "-ExecutionPolicy Bypass -File $scriptPath" -WindowStyle Hidden

      - name: Keep GitHub Actions Alive (12h with TCP log)
        run: |
          Write-Host "Keeping GitHub Actions alive for session..."
          for ($i=0; $i -lt 720; $i++) {
              Write-Host "Still running... minute $i"
              Start-Sleep -Seconds 60
              if ($i % 30 -eq 0) {
                  Write-Host "=== TCP Connections Snapshot ==="
                  netstat -an
                  Write-Host "================================"
              }
          }

      - name: Show Connection Info
        run: |
          Write-Host "=== RDP ACCESS ==="
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "User1: $env:RDP1_USER | Pass: $env:RDP1_PASS"
          Write-Host "User2: $env:RDP2_USER | Pass: $env:RDP2_PASS"
          Write-Host "VFun Launcher: C:\VFUNLauncherInstaller.exe"
          Write-Host "Anti-AFK + Ping script running in background"
          Write-Host "=================="
